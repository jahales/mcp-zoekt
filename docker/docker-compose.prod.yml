# Zoekt Infrastructure - Production Deployment
# Daily index updates via cron (see update-index.sh)
# Ports exposed: 6070 (Zoekt API), 3001 (MCP HTTP API)
# See README.md for setup instructions
#
# Required environment variables:
#   GITHUB_ORG - GitHub organization to index (e.g., "my-company")

services:
  # GitHub mirror - clones/updates repos from GitHub
  # Runs on schedule via cron container
  zoekt-mirror:
    image: zoekt:local
    container_name: zoekt-mirror
    environment:
      - GITHUB_ORG=${GITHUB_ORG:?GITHUB_ORG is required}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        TOKEN=$$(cat /config/github-token.txt)
        git config --global url."https://$$TOKEN@github.com/".insteadOf "https://github.com/"
        echo "Starting mirror at $$(date)"
        zoekt-mirror-github -dest /data/repos -org $${GITHUB_ORG} -token /config/github-token.txt -no_archived
        echo "Mirror complete at $$(date)"
    volumes:
      - zoekt-data:/data
      - ./config:/config:ro
    restart: "no"
    profiles:
      - mirror
    networks:
      - zoekt

  # Indexer - indexes cloned repos after mirror completes
  zoekt-indexer:
    image: zoekt:local
    container_name: zoekt-indexer
    environment:
      - GITHUB_ORG=${GITHUB_ORG:?GITHUB_ORG is required}
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Starting indexing at $$(date)"
        for repo in /data/repos/github.com/$${GITHUB_ORG}/*.git; do
          if [ -d "$$repo" ]; then
            echo "Indexing $$repo..."
            zoekt-git-index -index /data/index "$$repo" || echo "Failed to index $$repo"
          fi
        done
        echo "Indexing complete at $$(date)"
    volumes:
      - zoekt-data:/data
    restart: "no"
    profiles:
      - index
    networks:
      - zoekt

  # Webserver - serves search API (always running)
  zoekt-webserver:
    image: zoekt:local
    container_name: zoekt-webserver
    command: zoekt-webserver -index /data/index -rpc -listen :6070
    ports:
      - "6070:6070"  # HTTP API - accessible from dev machines
    volumes:
      - zoekt-data:/data:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:6070/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - zoekt

  # MCP Server - exposes Zoekt via MCP protocol (HTTP transport for remote access)
  zoekt-mcp:
    image: zoekt-mcp:local
    container_name: zoekt-mcp
    environment:
      - ZOEKT_URL=http://zoekt-webserver:6070
      - MCP_TRANSPORT=http
      - MCP_PORT=3001
      - MCP_HOST=0.0.0.0
      - LOG_LEVEL=info
    ports:
      - "3001:3001"  # MCP HTTP API - accessible from dev machines
    depends_on:
      zoekt-webserver:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - zoekt

volumes:
  zoekt-data:
    driver: local

networks:
  zoekt:
    driver: bridge
